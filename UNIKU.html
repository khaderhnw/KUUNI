<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Khalifa University • Housing Prototype (Single File, Complete)</title>
<meta name="theme-color" content="#0a2342">
<style>
/* =================  KU Housing Prototype Styles (single-file)  ================= */
:root{
  --ku-navy:#0a2342;
  --ku-blue:#1f6feb;
  --ku-sand:#f4f1ea;
  --ku-mint:#12a39e;
  --ku-ink:#0b132b;
  --text:#0b0f1a;
  --muted:#5b7083;
  --bg:#ffffff;
  --surface:#f7f9fc;
  --danger:#c62828;
  --warning:#b26a00;
  --success:#1b5e20;
  --border:#e6edf8;
  --radius:12px;
  --shadow:0 8px 24px rgba(2,12,27,0.08);
}

/* Base */
*{ box-sizing:border-box }
html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--surface); color:var(--text) }
a{ color:inherit }
.hidden{display:none !important}

/* Utility */
.container{ width:min(1200px,92vw); margin:0 auto }
.grid{ display:grid; gap:1.25rem }
.grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)) }
.grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
.card{ background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow); overflow:clip }
.card-pad{ padding: clamp(1rem,2.5vw,1.5rem) }
.tag{ display:inline-block; padding:.25rem .6rem; border-radius:999px; font-size:.8rem; background:#eef3ff; color:#1b3a82 }
.kicker{ text-transform:uppercase; letter-spacing:.12em; font-weight:700; color:var(--muted); font-size:.78rem }
.spacer{ flex:1 }
.list{margin:.6rem 0 0; padding-left:1.1rem}
.list li{margin:.35rem 0; color:#45546b}
.helper{color:var(--muted); font-size:.95rem}
.error-list{color:#a40000; margin:.5rem 0 0}
.deadline{font-variant-numeric:tabular-nums}

/* Masthead */
.masthead{ background:linear-gradient(180deg,var(--ku-ink) 0%,var(--ku-navy) 100%); color:#fff; position:sticky; top:0; z-index:1000; box-shadow:var(--shadow) }
.masthead .bar{ display:flex; align-items:center; gap:1rem; padding:.9rem 0 }
.logo{ display:flex; align-items:center; gap:.75rem; text-decoration:none; color:#fff }
.logo svg{ width:36px; height:36px }
.logo strong{ font-weight:800; letter-spacing:.02em }

/* Navbar */
.navbar{ background:#0f274a; color:#dce7ff }
.navbar nav{ display:flex; gap:.25rem; flex-wrap:wrap }
.navbar a{ color:inherit; text-decoration:none; padding:.8rem .9rem; border-radius:8px }
.navbar a:hover{ background:#0b1e3e }

/* Buttons */
.btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.65rem 1rem; border-radius:10px; text-decoration:none; font-weight:600; border:1px solid transparent; cursor:pointer }
.btn.primary{ background:var(--ku-blue); color:#fff }
.btn.secondary{ background:transparent; border-color:#7aa2f7; color:#e6f0ff }
.btn.ghost{ background:transparent; color:var(--ku-blue); border-color:#c8d6ff }
.btn.block{ width:100%; justify-content:center }
.btn.small{ padding:.45rem .7rem; font-size:.9rem; border-radius:8px }
.btn:focus-visible{ outline:3px solid #a7c0ff; outline-offset:2px }

/* Hero */
.hero{ padding: clamp(2.5rem, 5vw, 4rem) 0 }
.hero h1{ font-size: clamp(1.8rem, 3.5vw, 2.4rem); margin:.25rem 0 .5rem }
.hero p{ color:var(--muted); max-width:68ch }

/* Campus cards */
.campus-card{ position:relative; overflow:hidden; min-height:280px; display:flex; border:1px solid var(--border) }
.campus-art{ width:100%; height:100%; background:var(--ku-blue); display:block }
.campus-card .overlay{ position:absolute; inset:0; background:linear-gradient(0deg,rgba(10,35,66,.58),rgba(10,35,66,0)) }
.campus-card .content{ position:absolute; bottom:0; left:0; padding:1.1rem; color:#fff }
.campus-card h3{ margin:0 0 .25rem }
.campus-card .meta{ font-size:.9rem; opacity:.92 }

/* Footer */
footer{ margin-top:3rem; padding:2rem 0; color:#7f8aa3 }

/* Panels / steps */
.panel h2{ margin:.5rem 0 1rem }
.panel .lead{ color:var(--muted); max-width:75ch }
.step{ display:flex; gap:1rem; align-items:flex-start }
.step .num{ width:36px; height:36px; border-radius:999px; background:var(--ku-blue); color:#fff; font-weight:700; display:grid; place-items:center; margin-top:.25rem }

/* Alerts */
.alert{ border-left:4px solid var(--warning); background:#fff6e5; padding:1rem; border-radius:10px }
.alert.danger{ border-left-color:var(--danger); background:#ffecec }
.alert.success{ border-left-color:var(--success); background:#e9f9ee }

/* OSC (portal) */
.portal-header{ background:#0b1e3e; color:#e8f0ff; padding:1rem 0 }
.portal-nav{ background:#12284a; color:#cfe0ff }
.menu{ display:flex; gap:.75rem; flex-wrap:wrap; padding:.4rem 0 }
.mitem{ position:relative }
.mitem>button{ background:transparent; color:inherit; border:0; padding:.7rem .9rem; border-radius:8px; font-weight:600; display:flex; align-items:center; gap:.4rem; cursor:pointer }
.mitem>button:hover, .mitem>button:focus-visible{ background:#0e2142; outline:none }
.dropdown{ position:absolute; left:0; top:100%; background:#fff; color:var(--text); min-width:240px; border-radius:12px; box-shadow:var(--shadow); padding:.35rem; display:none; z-index:50 }
.dropdown a{ display:flex; align-items:center; justify-content:space-between; text-decoration:none; color:inherit; padding:.6rem .75rem; border-radius:8px }
.dropdown a:hover{ background:#f2f6ff }
.mitem[aria-expanded="true"] .dropdown{ display:block }

.portal-main{ padding:1.25rem 0 2rem }
.kpanel{ background:#fff; border-radius:12px; box-shadow:var(--shadow); padding:1rem 1.1rem }
.kpanel .actions{ display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0 0 }

/* Forms */
label{ display:block; font-weight:600; margin:.65rem 0 .2rem }
input[type="text"], input[type="date"], input[type="email"], select, textarea{
  width:100%; padding:.65rem .7rem; border-radius:10px; border:1px solid #c6cfdb; background:#fff
}
input[aria-invalid="true"], select[aria-invalid="true"], textarea[aria-invalid="true"]{
  border-color:#ff5a5a; box-shadow:0 0 0 3px rgba(255,90,90,.12)
}
.form-row{ display:grid; gap:1rem; grid-template-columns:repeat(2,minmax(0,1fr)) }
.progress{ height:8px; background:#e0e8ff; border-radius:999px; overflow:hidden }
.progress>span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--ku-blue),var(--ku-mint)); transition:width .4s ease }

/* ===== Rates & Room Types (tabs + uploads + popover) ===== */
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 14px}
.tabs [role="tab"]{appearance:none;border:1px solid var(--border);background:#fff;color:#0b1f44;padding:9px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.tabs [role="tab"][aria-selected="true"]{background:linear-gradient(180deg,#fff,#f3f7ff);border-color:#c9d6ff;color:#0a2342;box-shadow:0 1px 0 #fff inset, 0 0 0 2px #e6edff}
.tabpanel{display:none}
.tabpanel[aria-hidden="false"]{display:block}
h2.section-title{margin:0 0 8px;font-size:1.25rem}
.muted{color:var(--muted)}

.rates{width:100%;border-collapse:separate;border-spacing:0}
.rates caption{caption-side:top;text-align:left;font-weight:700;margin:0 0 8px}
.rates th,.rates td{padding:12px 14px;border-bottom:1px solid var(--border)}
.rates thead th{font-size:.92rem;text-transform:uppercase;letter-spacing:.04em;color:#314d72;background:#f6f9ff}
.rates tbody tr:last-child td,.rates tbody tr:last-child th{border-bottom:0}
.rates th[scope="row"]{font-weight:600}
.col-term,.col-month{white-space:nowrap;font-variant-numeric:tabular-nums}
.price{background:#f7fbff;border:1px solid #e6f0ff;border-radius:10px;padding:6px 10px;display:inline-block}
.hide-col .col-term,.hide-col .th-term{display:none}
.hide-col .col-month,.hide-col .th-month{display:none}
.hide-col.term .col-month,.hide-col.term .th-month{display:table-cell}
.hide-col.month .col-term,.hide-col.month .th-term{display:table-cell}

.photos .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.photos input[type="file"]{font-size:.9rem}
.thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.thumbs img{width:100%;aspect-ratio:1.3/1;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.empty{border:2px dashed #cfe0ff;border-radius:12px;display:grid;place-items:center;min-height:120px;color:#5f77a6;background:#f8fbff}
.rel{position:relative}
.popover{position:absolute;inset:auto auto auto 0;transform:translateY(8px);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;min-width:220px;display:none;z-index:10}
.popover .row{display:flex;align-items:center;gap:8px;margin:6px 0}

/* Timeline */
.timeline{list-style:none;margin:0;padding:0}
.timeline li{display:flex;gap:.75rem;align-items:flex-start;padding:.5rem 0;border-left:3px solid #e6edf8;margin-left:.6rem}
.timeline li::before{content:"";width:10px;height:10px;border-radius:999px;background:#cfe0ff;display:block;transform:translate(-7px,6px)}
.timeline .when{font-variant-numeric:tabular-nums;color:#5d6b83;font-size:.92rem}

/* ===== Home page upgrades ===== */
.pills{display:flex;gap:8px;flex-wrap:wrap;margin:.75rem 0 0}
.pill{background:#eef3ff;border:1px solid #dbe6ff;border-radius:999px;padding:.25rem .6rem;font-size:.85rem;color:#1b3a82}

.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:1rem 0 0}
.stat{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;text-align:center}
.stat h3{margin:2px 0 4px;font-size:1.4rem}
.stat p{margin:0;color:var(--muted);font-size:.92rem}

.features{margin:1.25rem 0 0}
.feature-card{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fff;display:flex;gap:.75rem;align-items:flex-start}
.feature-card .icon{width:28px;height:28px;flex:0 0 28px;border-radius:8px;display:grid;place-items:center;background:#f0f6ff;border:1px solid #dce7ff}
.feature-card h4{margin:.1rem 0 .25rem}
.feature-card p{margin:0;color:var(--muted)}

.snapshots{margin-top:1.25rem}
.snapshot{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fff}
.snapshot .price-lg{font-size:1.3rem;font-weight:800}

.quotes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:1.25rem}
.quote{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
.quote p{margin:.4rem 0 .6rem}
.quote .who{font-weight:700}
.quote .prog{color:var(--muted);font-size:.9rem}

.tour{margin-top:1.25rem}
.video-embed{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:linear-gradient(135deg,#1f6feb,#12a39e)}
.video-embed::before{content:"";display:block;aspect-ratio:16/9}
.video-embed .play{position:absolute;inset:0;display:grid;place-items:center}
.video-embed .play span{background:rgba(255,255,255,.92);border-radius:999px;padding:14px 18px;font-weight:800;color:#0a2342;border:2px solid #d9e6ff}

.faq{margin-top:1.25rem}
.faq details{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
.faq details+details{margin-top:8px}
.faq summary{cursor:pointer;font-weight:700;list-style:none}
.faq summary::-webkit-details-marker{display:none}
.faq p{margin:.5rem 0 0;color:var(--muted)}

.cta-banner{margin:1.5rem 0 0;border-radius:16px;padding:18px;border:1px solid var(--border);
  background:linear-gradient(180deg,#f7fbff,#eef6ff)}
.cta-banner h3{margin:.2rem 0 .4rem}
.cta-banner p{margin:0 0 .6rem;color:var(--muted)}

/* Responsive */
@media (max-width:860px){
  .grid-2,.grid-3{ grid-template-columns:1fr }
  .top-actions{ display:none }
  .stats{grid-template-columns:repeat(2,1fr)}
  .quotes{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <!-- ===== Header / global nav ===== -->
  <header class="masthead" id="masthead-global">
    <div class="container bar">
      <a class="logo" href="#home" aria-label="Khalifa University">
        <!-- KU-style geometric logo (placeholder vector) -->
        <svg viewBox="0 0 64 64" aria-hidden="true" class="ku-logo">
          <defs>
            <linearGradient id="kuG" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#1f6feb"/>
              <stop offset="1" stop-color="#12a39e"/>
            </linearGradient>
          </defs>
          <rect x="2.5" y="2.5" width="59" height="59" rx="12" fill="none" stroke="white" stroke-width="3"/>
          <g transform="translate(32,32)">
            <path d="M0,-16 L5,-5 L16,0 L5,5 L0,16 L-5,5 L-16,0 L-5,-5 Z"
              fill="url(#kuG)" stroke="white" stroke-width="1.2" />
          </g>
        </svg>
        <strong>Khalifa University</strong>
        <span aria-hidden="true">|</span>
        <span>Student Housing</span>
      </a>
      <div class="spacer"></div>
      <div class="top-actions">
        <a class="btn secondary" href="#how">How to Apply</a>
        <a class="btn primary" href="#login">Apply / My Account</a>
      </div>
    </div>
    <div class="navbar">
      <div class="container">
        <nav aria-label="Primary">
          <a href="#home">Home</a>
          <a href="#how">Getting Started</a>
          <a href="#campus/main">Residences & Rooms</a>
          <a href="#login">Applications</a>
          <a href="#" title="Coming soon">Dining</a>
          <a href="#" title="Coming soon">Residence Life</a>
          <a href="#" title="Coming soon">Other Housing</a>
          <span class="spacer"></span>
          <a class="btn small ghost" href="#login">My Account</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- ===== View container (SPA router) ===== -->
  <main id="view"></main>

  <footer>
    <div class="container grid grid-3">
      <div>
        <strong>Khalifa University</strong><br/>Student Housing & Community Services
      </div>
      <div>
        <a href="#how">How to apply</a><br/>
        <a href="#login">Online Service Centre</a>
      </div>
      <div>© 2025 KU (Demo Prototype)</div>
    </div>
  </footer>

<script>
/* ===========================================================
   SIMPLE SPA ROUTER — one-file demo (enhanced & complete)
   =========================================================== */
const $ = (sel, root=document) => root.querySelector(sel);

/* ------- Shared price map for fee estimator (wizard) ------- */
const PRICE_DATA = {
  'Main Campus': {
    'Single': {term:14500, month:3200},
    'Double (shared)': {term:10900, month:2450},
    'Double': {term:10900, month:2450},
    'Studio': {term:18400, month:4100}
  },
  'Sas Al Nakhl': {
    'Single': {term:12800, month:2900},
    'Double (shared)': {term:9600, month:2200},
    'Double': {term:9600, month:2200},
    'Studio': {term:16900, month:3800}
  }
  // Masdar City rates not displayed in demo → estimator shows N/A.
};

/* ------- Page templates ------- */
const TPL = {
  home(){
    return `
      <section class="hero">
        <div class="container grid grid-2">
          <div>
            <span class="kicker">Welcome</span>
            <h1>Live where you learn</h1>
            <p>KU residence puts you steps from classes, labs, clubs, and friends—so you can spend less time commuting and more time doing what matters.</p>
            <p class="helper">Fall applications close in <span class="deadline" data-deadline="2025-06-30T23:59:00+04:00">--</span>.</p>
            <div class="pills" aria-label="Highlights">
              <span class="pill">Furnished rooms</span>
              <span class="pill">High‑speed Wi‑Fi</span>
              <span class="pill">Study lounges</span>
              <span class="pill">24/7 support</span>
              <span class="pill">Secure access</span>
            </div>
            <div class="actions" style="margin-top:.9rem;">
              <a class="btn primary" href="#login">Apply to Residence</a>
              <a class="btn ghost" href="#how">How to apply</a>
            </div>

            <div class="stats">
              <div class="stat"><h3>5 min</h3><p>to labs & lectures</p></div>
              <div class="stat"><h3>24/7</h3><p>front desk & security</p></div>
              <div class="stat"><h3>1 Gbps</h3><p>Wi‑Fi in lounges</p></div>
              <div class="stat"><h3>100+</h3><p>residence events/yr</p></div>
            </div>
          </div>

          <div class="grid grid-3 features" aria-label="Why KU Housing">
            ${[
              ['Zero commute','Wake up on campus—save time (and taxi money).','building'],
              ['Study‑first spaces','Quiet floors, lounges, and group rooms.','book'],
              ['All‑inclusive','Utilities included; maintenance handled.','plug'],
              ['Safer by design','Secure access, CCTV, and on‑call staff.','shield'],
              ['Community & leadership','Meet friends, lead programs, build your CV.','users'],
              ['Healthy living','Meal plans, gyms nearby, and green spaces.','heart']
            ].map(([title,desc,icon])=>`
              <div class="feature-card">
                <div class="icon" aria-hidden="true">${ICON(icon)}</div>
                <div><h4>${title}</h4><p>${desc}</p></div>
              </div>
            `).join('')}
          </div>
        </div>
      </section>

      <section class="container snapshots">
        <div class="grid grid-2">
          <div class="snapshot">
            <span class="kicker">Main Campus</span>
            <h3 style="margin:.2rem 0 .35rem;">Rates snapshot</h3>
            <ul class="list">
              <li>Single from <span class="price-lg">AED 14,500</span> / term</li>
              <li>Double from AED 10,900 / term</li>
              <li>Studio from AED 18,400 / term</li>
            </ul>
            <div class="actions" style="margin-top:.6rem;">
              <a class="btn ghost" href="#campus/main">View rooms</a>
            </div>
          </div>
          <div class="snapshot">
            <span class="kicker">Sas Al Nakhl</span>
            <h3 style="margin:.2rem 0 .35rem;">Rates snapshot</h3>
            <ul class="list">
              <li>Single from <span class="price-lg">AED 12,800</span> / term</li>
              <li>Double from AED 9,600 / term</li>
              <li>Studio from AED 16,900 / term</li>
            </ul>
            <div class="actions" style="margin-top:.6rem;">
              <a class="btn ghost" href="#campus/sas">View rooms</a>
            </div>
          </div>
        </div>
      </section>

      <section class="container tour">
        <div class="grid grid-2">
          <div>
            <h3 style="margin:.2rem 0 .35rem;">Take a 60‑second tour</h3>
            <a class="video-embed" href="#campus/main" aria-label="Open residence tour (demo)">
              <div class="play"><span>▶</span></div>
            </a>
            <p class="helper" style="margin:.5rem 0 0;">Explore rooms, lounges, and amenities. (Demo video placeholder)</p>
          </div>
          <div>
            <h3 style="margin:.2rem 0 .35rem;">Where you’ll live</h3>
            <ul class="list">
              <li>${INLINE('map-pin')} 3–8 minutes to classrooms</li>
              <li>${INLINE('bus')} Shuttle service between campuses</li>
              <li>${INLINE('food')} Dining halls & cafés nearby</li>
              <li>${INLINE('leaf')} Courtyards, quiet zones, and prayer spaces</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="container">
        <span class="kicker">Student voices</span>
        <div class="quotes">
          ${[
            ['“I met my capstone team in the residence lounge. Best decision I made.”','Sara A.','BSc Mechanical'],
            ['“Saving 90 minutes a day not commuting changed my GPA.”','Omar K.','BSc Electrical'],
            ['“24/7 front desk made move‑in and late‑night labs stress‑free.”','Noura M.','MSc Computing']
          ].map(([q,who,prog])=>`
            <div class="quote">
              <p>${q}</p>
              <div class="who">${who}</div>
              <div class="prog">${prog}</div>
            </div>
          `).join('')}
        </div>
      </section>

      <section class="container faq">
        <span class="kicker">FAQ</span>
        <details>
          <summary>Am I guaranteed housing as a first‑year?</summary>
          <p>First‑year applicants who apply by the deadline are prioritized during allocation.</p>
        </details>
        <details>
          <summary>Can I request a roommate?</summary>
          <p>Yes. Include a preferred roommate (name or KU ID) in your application. Requests must be mutual.</p>
        </details>
        <details>
          <summary>What if I have accessibility or medical needs?</summary>
          <p>Share details in “Accessibility” on the application and opt‑in for a confidential follow‑up.</p>
        </details>
        <details>
          <summary>When will I hear back?</summary>
          <p>Applications typically move from “Submitted” to “In Review” within a few business days.</p>
        </details>
      </section>

      <section class="container cta-banner">
        <span class="kicker">Ready to apply?</span>
        <h3>Join a community that supports how you learn, live, and lead.</h3>
        <p>Start your application now—save progress anytime before the deadline.</p>
        <a class="btn primary" href="#login">Apply / Sign in</a>
      </section>
    `;
  },

  how(){
    return `
      <main class="container">
        <section class="panel">
          <div class="kicker">How To Apply</div>
          <h2>Ready • Set • Go</h2>
          <p class="lead">These are the steps we’ll ask every applicant to complete. The Online Service Centre guides you through them and tracks your progress.</p>
          <div class="grid">
            <div class="card card-pad">
              <div class="step">
                <div class="num" aria-hidden="true">1</div>
                <div class="body">
                  <h3>Ready — Choose your intake</h3>
                  <p>Select your term (Fall/Spring/Summer) and preferred campus. Check your eligibility and gather documents.</p>
                  <ul class="list">
                    <li>Government ID / passport</li>
                    <li>Admission letter or student ID number</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card card-pad">
              <div class="step">
                <div class="num">2</div>
                <div class="body">
                  <h3>Set — Pick preferences</h3>
                  <p>Rank up to three residences and room types. Share accessibility needs and roommate preferences.</p>
                </div>
              </div>
            </div>
            <div class="card card-pad">
              <div class="step">
                <div class="num">3</div>
                <div class="body">
                  <h3>Go — Apply & pay</h3>
                  <p>Submit your application and pay the application fee to enter the allocation process. Track status anytime.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="alert" style="margin-top:1rem;">
            Construction notice: select buildings may have periodic maintenance works. We’ll show any affected residences in the application.
          </div>

          <div style="margin-top:1rem;">
            <a class="btn primary" href="#login">Apply through Online Service Centre</a>
          </div>
        </section>
      </main>
    `;
  },

  campus({name, slug, blurb, showRates}){
    const tabs = `
      <section class="container" style="margin-bottom:2rem;">
        <div class="tabs" role="tablist" aria-label="Campuses">
          <button role="tab" id="tab-main-btn" aria-selected="${slug==='main'}" aria-controls="panel-main">Main Campus</button>
          <button role="tab" id="tab-san-btn" aria-selected="${slug==='sas'}" aria-controls="panel-san">Sas Al Nakhl</button>
        </div>

        <!-- MAIN PANEL -->
        <section id="panel-main" class="tabpanel" role="tabpanel" tabindex="0" aria-labelledby="tab-main-btn" aria-hidden="${slug==='main' ? 'false':'true'}">
          ${RATES_PANEL('main')}
        </section>

        <!-- SAS PANEL -->
        <section id="panel-san" class="tabpanel" role="tabpanel" tabindex="0" aria-labelledby="tab-san-btn" aria-hidden="${slug==='sas' ? 'false':'true'}">
          ${RATES_PANEL('san')}
        </section>
      </section>
    `;
    return `
      <section class="hero">
        <div class="container grid grid-2">
          <div>
            <h1>Live in residence at KU ${name}</h1>
            <p class="lead">${blurb}</p>
            <a class="btn primary" href="#login">Apply / Sign in</a>
          </div>
          <div class="card card-pad">
            <span class="kicker">Quick facts</span>
            <ul class="list">
              <li>Move-in: late August for Fall term</li>
              <li>Room types: Single, Double, Studio</li>
              <li>Front desk support: 24/7</li>
              <li>Maintenance requests via Online Service Centre</li>
            </ul>
          </div>
        </div>
      </section>
      ${showRates ? tabs : ''}
    `;
  },

  login(){
    return `
      <header class="portal-header">
        <div class="container">
          <strong>KU Student Housing & Community Services</strong><br/>Online Service Centre
        </div>
      </header>
      <main class="container" style="padding:1rem 0 2rem;">
        <h1>Welcome</h1>
        <div class="grid grid-2">
          <div class="card card-pad">
            <h3>Students & staff with KU login</h3>
            <p>Use your KU Single Sign-On (SSO) to access the Online Service Centre.</p>
            <a class="btn primary" href="#osc">Login with SSO</a>
          </div>
          <div class="card card-pad">
            <h3>Guests with a Housing ID</h3>
            <p>Visiting researchers or conference guests may use a Housing ID provided in email.</p>
            <a class="btn ghost" href="#osc">Login with Housing ID</a>
          </div>
        </div>

        <div class="alert danger" style="margin-top:1rem;">
          The Online Service Centre will be unavailable due to scheduled maintenance on Thursday, 25 Sep, 5:00 PM–9:30 PM GST. For urgent issues, contact your residence front desk.
        </div>

        <div class="card card-pad" style="margin-top:1rem;">
          <h3>This portal lets you:</h3>
          <ul class="list">
            <li>Apply for student housing, check status, make payments, submit maintenance requests.</li>
            <li>Sign up for meal plans and view balances.</li>
            <li>View and pay for child care accounts (if applicable).</li>
          </ul>
        </div>
      </main>
    `;
  },

  osc(sub=''){
    // Subroutes: '', 'apply', 'status', 'maintenance', 'thanks'
    const inner = {
      '': `
        <div class="kpanel">
          <h3>Welcome to the Student Housing & Services Centre</h3>
          <p class="lead">From one hub you can apply for housing, track status, make payments, submit maintenance requests, and manage your move-in/out checklist.</p>
          <div class="actions">
            <a class="btn primary" href="#osc/apply">Start a new application</a>
            <a class="btn ghost" href="#osc/status">Check status</a>
            <a class="btn ghost" href="#osc/maintenance">Report maintenance</a>
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:1rem;">
          ${['Application','Before Moving In','After Moving In'].map((t,i)=>`
            <div class="card card-pad">
              <span class="kicker">${t}</span>
              <h3 style="margin:.35rem 0 .4rem">${['Quick actions','Your checklist','Your tools'][i]}</h3>
              <ul class="list">
                ${i===0 ? `
                  <li>Apply, update, or cancel your residence application</li>
                  <li>Set roommate preferences</li>
                  <li>Make payments and view receipts</li>` :
                i===1 ? `
                  <li>Upload ID and complete emergency contacts</li>
                  <li>Pick your move-in time slot</li>
                  <li>Read residence community standards</li>` :
                `
                  <li>Room inventory & condition report</li>
                  <li>Maintenance request</li>
                  <li>Room transfer & subletting</li>`}
              </ul>
            </div>
          `).join('')}
        </div>
      `,
      'apply': `
        <div class="kpanel">
          <div class="breadcrumbs">Application</div>
          <h3>Residence Application</h3>
          <p class="lead">Complete the steps below. Progress is auto‑saved so you can return later.</p>
          <div class="progress" aria-label="Application progress"><span data-progress style="width:0%"></span></div>
          <div style="margin:.6rem 0 .2rem;" aria-live="polite" class="tag" data-step-label>Step 1 of 5</div>

          <form class="card card-pad" id="kuAppForm" novalidate>
            <!-- STEP 1: Profile -->
            <section data-pane="1">
              <h4>1) Profile & Eligibility</h4>
              <div class="form-row">
                <div>
                  <label for="kuid">KU ID / Admission #</label>
                  <input id="kuid" data-field="profile.kuid" required pattern="^[A-Za-z0-9-]{4,}$" placeholder="e.g., 2025-12345">
                  <div class="helper">Use your student number if you have one.</div>
                </div>
                <div>
                  <label for="email">KU Email</label>
                  <input id="email" type="email" data-field="profile.email" required placeholder="you@ku.ac.ae">
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Full Name</label>
                  <input data-field="profile.name" required>
                </div>
                <div>
                  <label>Date of Birth</label>
                  <input type="date" data-field="profile.dob" required>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Nationality</label>
                  <input data-field="profile.nationality" required>
                </div>
                <div>
                  <label>Level of Study</label>
                  <select data-field="profile.level" required>
                    <option value="">Select...</option>
                    <option>Undergraduate</option><option>Graduate</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Program / Major</label>
                  <input data-field="profile.program" required>
                </div>
                <div>
                  <label>Expected Graduation Term</label>
                  <input data-field="profile.gradTerm" placeholder="e.g., Spring 2028">
                </div>
              </div>
              <label><input type="checkbox" data-field="profile.sponsored"> I am sponsored / on a scholarship</label>
              <div class="helper">If you’re under 18, we’ll collect guardian details after submission.</div>
            </section>

            <!-- STEP 2: Term & Campus -->
            <section data-pane="2" hidden>
              <h4>2) Term & Campus</h4>
              <div class="form-row">
                <div>
                  <label>Term</label>
                  <select data-field="term.term" required>
                    <option value="">Select...</option>
                    <option>Fall 2025</option><option>Spring 2026</option><option>Summer 2026</option>
                  </select>
                </div>
                <div>
                  <label>Campus</label>
                  <select data-field="term.campus" required>
                    <option value="">Select...</option>
                    <option>Main Campus</option><option>Masdar City</option><option>Sas Al Nakhl</option>
                  </select>
                </div>
              </div>
            </section>

            <!-- STEP 3: Preferences & Accessibility -->
            <section data-pane="3" hidden>
              <h4>3) Residence Preferences</h4>
              <div class="form-row">
                <div>
                  <label>1st choice residence</label>
                  <select data-field="prefs.rank1">
                    <option>Any</option><option>Falcon Hall</option><option>Pearl Towers</option><option>Desert Crescent</option>
                  </select>
                </div>
                <div>
                  <label>2nd choice residence</label>
                  <select data-field="prefs.rank2">
                    <option>Any</option><option>Falcon Hall</option><option>Pearl Towers</option><option>Desert Crescent</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>3rd choice residence</label>
                  <select data-field="prefs.rank3">
                    <option>Any</option><option>Falcon Hall</option><option>Pearl Towers</option><option>Desert Crescent</option>
                  </select>
                </div>
                <div>
                  <label>Room type</label>
                  <select data-field="prefs.roomType">
                    <option>Any</option><option>Single</option><option>Double</option><option>Studio</option>
                  </select>
                </div>
              </div>
              <label>Accessibility / medical accommodation</label>
              <textarea rows="3" data-field="prefs.accessibility" placeholder="Optional: mobility, sensory, or medical needs"></textarea>
              <label><input type="checkbox" data-field="prefs.accomFollowup"> Request a confidential follow‑up about accessibility</label>
              <div class="form-row">
                <div>
                  <label>Quiet hours preference</label>
                  <select data-field="prefs.quiet"><option>No preference</option><option>Early sleeper</option><option>Night owl</option></select>
                </div>
                <div>
                  <label>Cleanliness preference</label>
                  <select data-field="prefs.clean"><option>Easy‑going</option><option>Average</option><option>Very tidy</option></select>
                </div>
              </div>
            </section>

            <!-- STEP 4: Roommates -->
            <section data-pane="4" hidden>
              <h4>4) Roommates & Community</h4>
              <div class="form-row">
                <div>
                  <label>Preferred roommate (optional)</label>
                  <input data-field="mate.name" placeholder="Name or KU ID">
                </div>
                <div>
                  <label>Languages (comma‑separated)</label>
                  <input data-field="mate.langs" placeholder="English, Arabic, …">
                </div>
              </div>
              <label><input type="checkbox" data-field="mate.matching"> Opt‑in to roommate matching survey</label>
            </section>

            <!-- STEP 5: Review & Pay -->
            <section data-pane="5" hidden>
              <h4>5) Review & Pay</h4>
              <p>Application fee: <strong>AED 150</strong></p>
              <div id="estimateBox" class="helper" style="margin:.25rem 0 .5rem;">
                Estimated housing cost based on your selections:
                <strong><span id="estTerm">—</span> / term</strong> • <strong><span id="estMonth">—</span> / month</strong>
              </div>
              <div id="summaryBox" class="card card-pad" style="border:1px solid var(--border);box-shadow:none;">
                <div class="kicker">Summary</div>
                <div id="summaryContent">Your selections will appear here.</div>
              </div>
              <label style="margin-top:.65rem;"><input type="checkbox" data-field="consent.standards" required> I agree to the Residence Community Standards</label>
              <label><input type="checkbox" data-field="consent.privacy" required> I consent to the housing office processing my data for allocation</label>
              <div id="errorSummary" class="error-list" role="alert" aria-live="polite"></div>
            </section>

            <div style="display:flex;gap:.5rem;margin-top:.75rem;flex-wrap:wrap">
              <button class="btn" id="saveDraft" type="button">Save draft</button>
              <button class="btn" id="clearDraft" type="button">Clear draft</button>
              <span class="spacer"></span>
              <button class="btn ghost" id="prevStep" type="button">Back</button>
              <button class="btn primary" id="nextStep" type="submit">Next</button>
            </div>
          </form>
        </div>
      `,
      'status': `
        <div class="kpanel">
          <div class="breadcrumbs">Application</div>
          <h3>Check Status</h3>
          <p class="lead">Below are your current applications.</p>
          <div class="card card-pad">
            <div class="grid grid-3">
              ${[
                {term:'Fall 2025', campus:'Main Campus', status:'In Review'},
                {term:'Spring 2026', campus:'Masdar City', status:'Submitted'},
                {term:'Summer 2026', campus:'Sas Al Nakhl', status:'Draft'}
              ].map(a=>`
                <div class="card card-pad" style="box-shadow:none;border:1px solid #e6edf8;">
                  <div class="kicker">${a.term}</div>
                  <h4 style="margin:.2rem 0 .3rem">${a.campus}</h4>
                  <span class="tag">${a.status}</span>
                  <div class="actions" style="margin-top:.6rem;">
                    <a class="btn small ghost" href="#osc/apply">Open</a>
                    <a class="btn small ghost" href="#">Cancel</a>
                  </div>
                  <ul class="timeline" style="margin-top:.6rem;">
                    <li><div><strong>Submitted</strong><div class="when">2025‑05‑12</div></div></li>
                    <li><div><strong>In Review</strong><div class="when">2025‑05‑15</div></div></li>
                    <li><div><strong>Allocation</strong><div class="when">Pending</div></div></li>
                    <li><div><strong>Offer Sent</strong><div class="when">Pending</div></div></li>
                  </ul>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `,
      'maintenance': `
        <div class="kpanel">
          <div class="breadcrumbs">After Moving In</div>
          <h3>Maintenance Request</h3>
          <form class="card card-pad">
            <div class="form-row">
              <div><label>Building</label><input type="text" placeholder="e.g., Falcon Hall" required></div>
              <div><label>Room</label><input type="text" placeholder="e.g., 4-217" required></div>
            </div>
            <label>Category</label>
            <select required><option value="">Select...</option><option>Electrical</option><option>Plumbing</option><option>Furniture</option><option>Other</option></select>
            <label>Describe the issue</label>
            <textarea rows="4" placeholder="Provide a short description" required></textarea>
            <div class="actions">
              <button class="btn primary" type="button">Submit Request</button>
              <button class="btn ghost" type="reset">Reset</button>
            </div>
          </form>
          <div class="alert" style="margin-top:1rem;">
            For urgent issues (water leaks, electrical hazards), contact Residence Front Desk: +971-2-XXXXXXX
          </div>
        </div>
      `,
      'thanks': `
        <div class="kpanel">
          <h3>Application Submitted</h3>
          <p class="lead">We emailed your receipt and will update your status within 3–5 business days.</p>
          <div class="actions">
            <a class="btn primary" href="#osc/status">View Status</a>
            <a class="btn ghost" href="#osc/apply">Start another application</a>
          </div>
        </div>
      `
    }[sub || ''];

    return `
      <header class="portal-header">
        <div class="container">
          <strong>KU Student Housing & Community Services (SHCS)</strong><br/>Online Service Centre
        </div>
      </header>
      <div class="portal-nav">
        <div class="container">
          <div class="menu" role="menubar" aria-label="Portal Navigation">
            <div class="mitem" aria-expanded="false">
              <button aria-haspopup="true" aria-expanded="false">Prospective Residents ▾</button>
              <div class="dropdown" role="menu">
                <a href="#osc/apply">Apply</a>
                <a href="#osc/status">Check Status</a>
                <a href="#osc/apply">Roommate Preferences</a>
              </div>
            </div>
            <div class="mitem" aria-expanded="false">
              <button aria-haspopup="true" aria-expanded="false">Residents ▾</button>
              <div class="dropdown">
                <a href="#osc/apply">Application</a>
                <a href="#osc/maintenance">Maintenance Request</a>
                <a href="#osc/apply">Room Transfer</a>
                <a href="#osc/apply">Sublet Application</a>
              </div>
            </div>
            <div class="mitem" aria-expanded="false">
              <button aria-haspopup="true" aria-expanded="false">Dining ▾</button>
              <div class="dropdown">
                <a href="#">Sign up for meal plan</a>
                <a href="#">Check balance</a>
              </div>
            </div>
            <span class="spacer"></span>
            <strong>29856044</strong>
            <a class="btn small ghost" href="#home" style="margin-left:.5rem;">Log Out</a>
          </div>
        </div>
      </div>

      <main class="container portal-main">
        <div id="osc-pane">${inner}</div>
        <div class="grid grid-2" style="margin-top:1rem;">
          <div class="card card-pad">
            <span class="kicker">News & Updates</span>
            <ul class="list">
              <li>Fall applications close 30 June.</li>
              <li>Room inventory opens after check-in day.</li>
            </ul>
          </div>
          <div class="card card-pad">
            <span class="kicker">Contact Us</span>
            <ul class="list">
              <li>Student Housing | Main Campus</li>
              <li>Student Housing | Masdar City</li>
              <li>Student Housing | Sas Al Nakhl</li>
            </ul>
          </div>
        </div>
      </main>
    `;
  }
};

// ------- Helper: Rates panel HTML (used by campus pages) -------
function RATES_PANEL(which){
  // which: 'main' or 'san'
  const data = {
    main: {
      rates: [
        ['Single','14,500','3,200'],
        ['Double (shared)','10,900','2,450'],
        ['Studio','18,400','4,100']
      ],
      inc: [
        'Furnished rooms with desk & chair',
        'Wi-Fi, A/C, laundry, study lounges, prayer space',
        '24/7 security & front desk'
      ]
    },
    san: {
      rates: [
        ['Single','12,800','2,900'],
        ['Double (shared)','9,600','2,200'],
        ['Studio','16,900','3,800']
      ],
      inc: [
        'Furnished rooms with study desks',
        'Wi-Fi, A/C, laundry',
        'Courtyards & quiet zones • Shuttle to Main Campus'
      ]
    }
  }[which];

  const tableRows = data.rates.map(r =>
    `<tr><th scope="row">${r[0]}</th><td class="col-term"><span class="price">${r[1]}</span></td><td class="col-month"><span class="price">${r[2]}</span></td></tr>`
  ).join('');

  const inc = data.inc.map(i=>`<li>${i}</li>`).join('');

  const slug = which==='main' ? 'main' : 'san';

  return `
    <div class="card card-pad">
      <div class="grid grid-2">
        <div>
          <h2 class="section-title">Rates &amp; Room Types</h2>
          <table class="rates" aria-describedby="inc-${slug}" id="rates-${slug}">
            <caption class="muted">Academic year pricing (AED)</caption>
            <colgroup><col style="width:48%"><col style="width:26%"><col style="width:26%"></colgroup>
            <thead><tr><th scope="col">Room</th><th scope="col" class="th-term">Per term (AED)</th><th scope="col" class="th-month">Per month (AED)</th></tr></thead>
            <tbody>${tableRows}</tbody>
          </table>
          <span class="kicker" id="inc-${slug}">What’s included</span>
          <ul class="list">${inc}</ul>
        </div>
        <aside class="photos">
          <h2 class="section-title">Photos</h2>
          <div class="toolbar rel">
            <button class="btn small" type="button" data-popover="pop-${slug}">Customize ▾</button>
            <label class="btn small" for="files-${slug}">Choose Files</label>
            <input id="files-${slug}" type="file" accept="image/*" multiple hidden>
            <div class="popover" id="pop-${slug}" aria-label="Customize columns">
              <div class="row"><strong>Columns</strong></div>
              <div class="row"><input type="checkbox" id="term-${slug}" checked><label for="term-${slug}">Show “Per term”</label></div>
              <div class="row"><input type="checkbox" id="month-${slug}" checked><label for="month-${slug}">Show “Per month”</label></div>
              <hr style="border:none;border-top:1px solid var(--border);margin:8px 0">
              <button class="btn small" type="button" data-close>Done</button>
            </div>
          </div>
          <div class="thumbs" id="thumbs-${slug}" aria-live="polite"><div class="empty">No photos yet</div></div>
        </aside>
      </div>
    </div>
  `;
}

/* ------- Small inline SVG helpers for feature/list icons ------- */
function ICON(name){
  const s = 'currentColor';
  const common = `width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${s}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
  const map = {
    building: `<svg ${common}><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M9 8h6M9 12h6M9 16h6M7 21v-4M17 21v-4"/></svg>`,
    book:     `<svg ${common}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4v15.5"/><path d="M20 4v13"/><path d="M6.5 4H20"/></svg>`,
    plug:     `<svg ${common}><path d="M12 22v-6M9 7V2M15 7V2"/><path d="M7 7h10a3 3 0 0 1 3 3v1H4v-1a3 3 0 0 1 3-3z"/></svg>`,
    shield:   `<svg ${common}><path d="M12 22s8-4 8-10V6l-8-3-8 3v6c0 6 8 10 8 10z"/></svg>`,
    users:    `<svg ${common}><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
    heart:    `<svg ${common}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`
  };
  return map[name] || '';
}
function INLINE(name){
  const s = 'currentColor';
  const common = `width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${s}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"`;
  const map = {
    'map-pin': `<svg ${common}><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
    bus: `<svg ${common}><rect x="3" y="5" width="18" height="13" rx="2"/><path d="M3 10h18M6 18v2M18 18v2"/><circle cx="7.5" cy="16.5" r="1.5"/><circle cx="16.5" cy="16.5" r="1.5"/></svg>`,
    food:`<svg ${common}><path d="M4 3v7a3 3 0 0 0 6 0V3M10 8H4"/><path d="M14 3h6l-1 9h-4z"/><path d="M16 12v7"/></svg>`,
    leaf:`<svg ${common}><path d="M11 21C7 21 3 17 3 13S7 3 11 3s8 4 8 8-4 10-8 10z"/><path d="M11 14c2 0 3-1 5-3"/></svg>`
  };
  return map[name] || '';
}

/* ------- Router ------- */
function render(){
  const hash = location.hash.replace(/^#/, '') || 'home';
  const [route, sub] = hash.split('/');
  const el = $('#view');

  // Toggle public masthead visibility on portal routes
  const hidePublic = (route==='login' || route==='osc');
  $('#masthead-global')?.classList.toggle('hidden', hidePublic);

  if(route === 'home') el.innerHTML = TPL.home();
  else if(route === 'how') el.innerHTML = TPL.how();
  else if(route === 'campus'){
    const cfg = {
      main: {name:'Main Campus', slug:'main', blurb:'Immerse yourself in campus life—steps from classrooms, labs and student services.', showRates:true},
      masdar: {name:'Masdar City', slug:'masdar', blurb:'Sustainable living near cutting-edge research facilities in Masdar City.', showRates:false},
      sas: {name:'Sas Al Nakhl', slug:'sas', blurb:'Peaceful residential community with easy shuttle connections to campus.', showRates:true}
    }[sub] || {name:'Campus', slug:'main', blurb:'', showRates:true};
    el.innerHTML = TPL.campus(cfg);
  }
  else if(route === 'login') el.innerHTML = TPL.login();
  else if(route === 'osc') el.innerHTML = TPL.osc(sub || '');
  else el.innerHTML = TPL.home();

  // After render, wire up interactive bits for the shown view:
  initMenus();         // portal menus if present
  initWizard();        // application wizard if present
  initRates();         // tabs, popovers, file previews if present
  initDeadline();      // countdown on home if present
}

window.addEventListener('hashchange', render);
window.addEventListener('load', render);

/* ------- Interactions ------- */
function initMenus(){
  // Single delegated handler for all dropdowns; attach once
  if(window.__kuMenuWired) return;
  window.__kuMenuWired = true;

  const closeAll = () => document.querySelectorAll('.mitem[aria-expanded="true"]').forEach(el=>el.setAttribute('aria-expanded','false'));

  document.addEventListener('click', e=>{
    const btn = e.target.closest('.mitem > button');
    if(btn){
      const parent = btn.parentElement;
      const expanded = parent.getAttribute('aria-expanded') === 'true';
      closeAll();
      parent.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      return;
    }
    if(!e.target.closest('.mitem')) closeAll();
  });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll() });
}

/* ------- Deadline countdown on home ------- */
function initDeadline(){
  const dEl = document.querySelector('[data-deadline]');
  if(!dEl) return;
  const deadline = new Date(dEl.dataset.deadline);
  const tick = () => {
    const diff = deadline - new Date();
    if(diff <= 0){ dEl.textContent = 'Deadline passed'; return; }
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor(diff / (1000*60*60)) % 24;
    dEl.textContent = days + 'd ' + hours + 'h';
  };
  tick(); setInterval(tick, 60000);
}

/* ------- Enhanced Wizard (autosave + validation + estimator) ------- */
function initWizard(){
  const form = document.querySelector('#kuAppForm');
  if(!form) return;

  const panes = [...form.querySelectorAll('[data-pane]')];
  const progress = document.querySelector('[data-progress]');
  const stepLabel = document.querySelector('[data-step-label]');
  const nextBtn = document.querySelector('#nextStep');
  const backBtn = document.querySelector('#prevStep');
  const saveBtn = document.querySelector('#saveDraft');
  const clearBtn = document.querySelector('#clearDraft');
  const errorSummary = document.querySelector('#errorSummary');
  const summaryContent = document.getElementById('summaryContent');
  const estTerm = document.getElementById('estTerm');
  const estMonth = document.getElementById('estMonth');

  const TOTAL = panes.length;
  const STORAGE_KEY = 'kuApp';
  let step = 1;
  let data = load() || {};

  // Bind fields with dot-path data-field
  form.querySelectorAll('[data-field]').forEach(el=>{
    const key = el.dataset.field;
    const val = get(data, key);
    if(val !== undefined){
      if(el.type === 'checkbox') el.checked = !!val;
      else el.value = val;
    }
    const write = ()=>{ set(data, key, el.type==='checkbox' ? el.checked : el.value); save(data); maybeUpdateSummary(); };
    el.addEventListener('input', write);
    el.addEventListener('change', write);
  });

  function show(n){
    panes.forEach((p,i)=> p.hidden = (i !== n-1));
    stepLabel.textContent = `Step ${n} of ${TOTAL}`;
    progress.style.width = `${(n-1)/(TOTAL-1)*100}%`;
    backBtn.disabled = n===1;
    nextBtn.textContent = n===TOTAL ? 'Submit Application' : 'Next';
    errorSummary && (errorSummary.textContent = '');
    if(n===TOTAL) maybeUpdateSummary();
  }

  function validateStep(n){
    let valid = true;
    const pane = panes[n-1];
    const requiredEls = pane.querySelectorAll('[required]');
    requiredEls.forEach(el=>{
      const ok = el.type==='checkbox' ? el.checked : !!String(el.value||'').trim();
      el.setAttribute('aria-invalid', String(!ok));
      if(!ok) valid = false;
    });
    if(!valid && errorSummary){
      errorSummary.textContent = 'Please complete the highlighted fields before continuing.';
      pane.scrollIntoView({behavior:'smooth',block:'start'});
    }
    return valid;
  }

  nextBtn.addEventListener('click', e=>{
    e.preventDefault();
    if(step < TOTAL){
      if(!validateStep(step)) return;
      step++; show(step);
    } else {
      if(!validateStep(step)) return;
      nextBtn.disabled = true; nextBtn.textContent = 'Submitting…';
      // Simulate submit → clear storage → thanks screen
      setTimeout(()=>{ localStorage.removeItem(STORAGE_KEY); location.hash = '#osc/thanks'; }, 800);
    }
  });
  backBtn.addEventListener('click', e=>{ e.preventDefault(); if(step>1){ step--; show(step);} });
  saveBtn.addEventListener('click', ()=>{ save(data); alert('Draft saved in your browser.'); });
  clearBtn.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); form.reset(); data={}; alert('Draft cleared.'); });

  function maybeUpdateSummary(){
    if(!summaryContent) return;
    const campus = get(data,'term.campus');
    const roomType = normalizeRoom(get(data,'prefs.roomType'));
    const price = estimate(campus, roomType);
    estTerm.textContent  = price?.term ? `AED ${fmt(price.term)}` : 'N/A';
    estMonth.textContent = price?.month ? `AED ${fmt(price.month)}` : 'N/A';

    const lines = [
      ['Name', get(data,'profile.name')],
      ['Email', get(data,'profile.email')],
      ['KU ID', get(data,'profile.kuid')],
      ['Level', get(data,'profile.level')],
      ['Term', get(data,'term.term')],
      ['Campus', campus],
      ['Room Type', roomType || 'Any'],
      ['1st Choice', get(data,'prefs.rank1') || '—'],
      ['2nd Choice', get(data,'prefs.rank2') || '—'],
      ['3rd Choice', get(data,'prefs.rank3') || '—'],
      ['Accessibility', get(data,'prefs.accessibility') ? 'Provided' : '—'],
      ['Roommate Pref', get(data,'mate.name') || '—'],
      ['Languages', get(data,'mate.langs') || '—']
    ];
    summaryContent.innerHTML = `
      <div class="grid grid-2">
        <div>
          <ul class="list">
            ${lines.slice(0,7).map(([k,v])=>`<li><strong>${k}:</strong> ${escapeHTML(v||'')}</li>`).join('')}
          </ul>
        </div>
        <div>
          <ul class="list">
            ${lines.slice(7).map(([k,v])=>`<li><strong>${k}:</strong> ${escapeHTML(v||'')}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;
  }

  function estimate(campus, roomType){
    if(!campus || !roomType) return null;
    const map = PRICE_DATA[campus];
    if(!map) return null;
    const entry = map[roomType];
    return entry || null;
  }
  function normalizeRoom(rt){ if(!rt || rt==='Any') return null; return rt; }
  function fmt(n){ return Number(n).toLocaleString('en-AE'); }
  function escapeHTML(str){ return String(str).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function save(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch{} }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null; } }
  function get(obj, path){ return path.split('.').reduce((o,k)=> o?.[k], obj); }
  function set(obj, path, value){
    const keys = path.split('.'); let ref = obj;
    keys.slice(0,-1).forEach(k=> ref = ref[k] = ref[k] ?? {});
    ref[keys.at(-1)] = value;
  }

  show(step); maybeUpdateSummary();
}

/* ------- Rates (tabs + popover + previews) ------- */
function initRates(){
  // Tabs
  document.querySelectorAll('[role="tablist"]').forEach(tablist=>{
    const tabs = tablist.querySelectorAll('[role="tab"]');
    const panels = tablist.parentElement.querySelectorAll('[role="tabpanel"]');
    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(t => t.setAttribute('aria-selected', String(t===btn)));
        panels.forEach(p => p.setAttribute('aria-hidden','true'));
        const target = document.getElementById(btn.getAttribute('aria-controls'));
        target?.setAttribute('aria-hidden','false');
        target?.focus({preventScroll:true});
      });
    });
  });

  // Popover + column toggles
  function wirePopover(popId, tableId, termId, monthId){
    const btn = document.querySelector(`[data-popover="${popId}"]`);
    const pop = document.getElementById(popId);
    const table = document.getElementById(tableId);
    const term = document.getElementById(termId);
    const month = document.getElementById(monthId);
    if(!btn || !pop || !table || !term || !month) return;

    function apply(){
      table.classList.remove('hide-col','term','month');
      if(!term.checked && !month.checked){ term.checked = true; }
      if(!term.checked){ table.classList.add('hide-col','term'); }
      if(!month.checked){ table.classList.add('hide-col','month'); }
    }

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      btn.classList.toggle('open');
      pop.style.display = btn.classList.contains('open') ? 'block' : 'none';
    });
    pop.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=>{
      btn.classList.remove('open'); pop.style.display = 'none';
    }));
    document.addEventListener('click', (e)=>{
      if(!btn.contains(e.target) && !pop.contains(e.target)){ btn.classList.remove('open'); pop.style.display='none'; }
    });
    [term,month].forEach(c=>c.addEventListener('change', apply));
    apply();
  }
  wirePopover('pop-main','rates-main','term-main','month-main');
  wirePopover('pop-san','rates-san','term-san','month-san');

  // Photo previews
  function wirePreview(inputId, thumbsId){
    const input = document.getElementById(inputId);
    const thumbs = document.getElementById(thumbsId);
    if(!input || !thumbs) return;
    input.addEventListener('change', ()=>{
      thumbs.innerHTML = '';
      if(!input.files || input.files.length===0){ thumbs.innerHTML = '<div class="empty">No photos yet</div>'; return; }
      [...input.files].forEach(file=>{
        const img = document.createElement('img');
        img.alt = file.name;
        img.src = URL.createObjectURL(file);
        img.onload = ()=> URL.revokeObjectURL(img.src);
        thumbs.appendChild(img);
      });
    });
  }
  wirePreview('files-main','thumbs-main');
  wirePreview('files-san','thumbs-san');
}
</script>
</body>
</html>
